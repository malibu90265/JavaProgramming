<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="DeployRequirmentsDAO">

	<resultMap type="com.sqisoft.iqs.humanResource.deployRequirements.vo.DeployRequirementsVO" id="DeployRequirementsVO">
		<result column="pj_id"				property="pj_id"/>
		<result column="pj_name"			property="pj_name"/>
		<result column="tm_id"				property="tm_id"/>
		<result column="pj_status"			property="pj_status"/>
		<result column="pj_sign_client"		property="pj_sign_client"/>
		<result column="pj_order_client"	property="pj_order_client"/>
		<result column="pj_LMD"				property="pj_LMD"/>
		<result column="pj_start_date"		property="pj_start_date"/>
		<result column="pj_end_date"		property="pj_end_date"/>
		<result column="pj_intro_stage"		property="pj_intro_stage"/>
		<result column="pj_begin_stage"		property="pj_begin_stage"/>
		<result column="pj_propose_stage"	property="pj_propose_stage"/>
		<result column="pj_contract_stage"	property="pj_contract_stage"/>
		<result column="pj_perform_stage"	property="pj_perform_stage"/>
		<result column="pj_pm"				property="pj_pm"/>
		<result column="pj_loc"				property="pj_loc"/>
		<result column="pj_cwm_env"			property="pj_cwm_env"/>
		<result column="pj_os"				property="pj_os"/>
		<result column="pj_DB"				property="pj_DB"/>
		<result column="pj_ui"				property="pj_ui"/>
		<result column="pj_lang"			property="pj_lang"/>
		<result column="pj_fw"				property="pj_fw"/>
		<result column="pj_mw"				property="pj_mw"/>
		<result column="pj_sqi_mm"			property="pj_sqi_mm"/>
		<result column="pj_out_mm"			property="pj_out_mm"/>
		<result column="pj_amount"			property="pj_amount"/>
		<result column="pj_put_num"			property="pj_put_num"/>
		<result column="pj_req_num"			property="pj_req_num"/>
		<result column="pj_matl_cost"		property="pj_matl_cost"/>
		<result column="pj_expense"			property="pj_expense"/>
		<result column="pj_extra_cost"		property="pj_extra_cost"/>
		<result column="pr_grade"			property="pr_grade"/>
		<result column="pr_job_skill"		property="pr_job_skill"/>
		<result column="pr_start_date"		property="pr_start_date"/>
		<result column="pr_end_date"		property="pr_end_date"/>
		<result column="pr_name"			property="pr_name"/>
		<result column="pr_sq"				property="pr_sq"/>
		<result column="pr_uprice"			property="pr_uprice"/>
		<result column="tm_name"			property="tm_name"/>
		<result column="pr_place"			property="pr_place"/>
	</resultMap>

	<select id="getTeamNames" resultMap="DeployRequirementsVO">
		SELECT	tm_id
				, tm_name
		FROM	team 
		WHERE	tm_year = year(SYSDATE())
	</select>

	<select id="getProjectList" parameterType="string" resultMap="DeployRequirementsVO">
		SELECT	pj_id
				, pj_name 
		FROM	project 
		WHERE	tm_id = #{tm_id}
	</select>
	
	<select id="getProjectInfoByPjId" parameterType="string" resultType="com.sqisoft.iqs.humanResource.deployRequirements.vo.DeployRequirementsVO">
		SELECT	pj_id
				, pj_start_date
				, pj_end_date
				, pj_pm
				, (	SELECT	count(*) 
					FROM	pj_required 
					WHERE	pj_id = #{pj_id}
					AND		NOT ISNULL(pr_name)
					AND		pr_name not like ''
				) AS 'pr_place'
				, pj_loc
				, pj_cwm_env
				, pj_os
				, pj_DB
				, pj_ui
				, pj_lang
				, pj_fw
				, pj_mw 
		FROM	project 
		WHERE	pj_id = #{pj_id}
	</select>
	
	<select id="getPjRequiredInfoByPjId" parameterType="string" resultMap="DeployRequirementsVO">
		SELECT	pj_id
				, pr_sq
				, pr_grade
				, pr_job_skill
				, pr_start_date
				, pr_end_date
				, pr_uprice
				, pr_name 
		FROM	pj_required 
		WHERE	pj_id = #{pj_id}
	</select>
	
	<select id="getHrInfoByName" parameterType="map" resultType="com.sqisoft.iqs.humanResource.humanResource.vo.HumanResourceVO">
		SELECT		first.hr_grade AS hr_grade
					, first.hr_residence AS hr_residence
					, IF(
							first.division = "외주"
							, first.hr_uprice
							, ( SELECT		hp_mon_price
								FROM		hr_price
								WHERE		(	SELECT		tm_id
												FROM		project
												WHERE		pj_id = #{pj_id}
											) = hp_team
								AND 		first.hr_position = hp_position
							)
					) AS hr_uprice
		FROM		(	SELECT		hr_grade
									, hr_uprice
									, hr_residence
									, hr_position
									, IF(hr_company LIKE "SQI%", "직원", "외주") AS division
						FROM		human_resource
						WHERE		hr_name = #{pr_name}
					) AS first
		<!-- 예전것 이제는 직원외주를 따로 가져오게 됨 -->
	</select>
	
	<insert id="insertPjRequired" parameterType="map">
		INSERT	INTO	pj_required 
		VALUES	(	#{pj_id}
					, #{pr_sq}
					, #{pr_grade}
					, #{pr_job_skill}
					, #{pr_start_date}
					, #{pr_end_date}
					, #{pr_uprice}
					, #{pr_name}
				) 
		ON		DUPLICATE KEY UPDATE
					pr_grade = #{pr_grade}
					, pr_name = #{pr_name}
					, pr_job_skill = #{pr_job_skill}
					, pr_start_date = #{pr_start_date}
					, pr_end_date = #{pr_end_date}
					, pr_uprice = #{pr_uprice}
	</insert>
	
	<delete id="deleteRequire" parameterType="map">
		DELETE
		FROM	pj_required
		WHERE	pj_id = #{pj_id}
		AND		pr_sq > #{pr_sq}
	</delete>
	
	<select id="checkNum" parameterType="string" resultType="_int">
		SELECT	IFNULL(MAX(pr_sq), 0) AS 'num'
		FROM	pj_required
		WHERE	pj_id = #{pj_id}
	</select>
	
	
	<update id="updatePjDeployInfo" parameterType="com.sqisoft.iqs.humanResource.vo.HRPriceVO">
		UPDATE	pj_deploy pd
		SET		pd.pd_uprice = (	SELECT	hr.hr_uprice
									FROM	human_resource hr
									WHERE	hr.hr_name = (	SELECT	pd.pd_name
															FROM	pj_deploy pd)
								)	
	</update>
</mapper>