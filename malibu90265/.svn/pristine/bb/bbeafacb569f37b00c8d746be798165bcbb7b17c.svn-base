<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="EmployeeInputDAO">

	<resultMap type="com.sqisoft.iqs.humanResource.employeeInput.vo.EmployeeInputVO" id="EmployeeInputVO">
		<result column="pj_id"			property="pj_id"/>
		<result column="pj_name"		property="pj_name"/>
		<result column="pj_start_date"	property="pj_start_date"/>
		<result column="pj_end_date"	property="pj_end_date"/>
		<result column="pj_loc"			property="pj_loc"/>
		<result column="pj_cwm_env"		property="pj_cwm_env"/>
		<result column="pj_put_num"		property="pj_put_num"/>
		<result column="pj_req_num"		property="pj_req_num"/>
		
		<result column="pr_grade"		property="pr_grade"/>
		<result column="pr_job_skill"	property="pr_job_skill"/>
		<result column="pr_start_date"	property="pr_start_date"/>
		<result column="pr_end_date"	property="pr_end_date"/>
		<result column="pr_name"		property="pr_name"/>
		<result column="pr_sq"			property="pr_sq"/>
		<result column="pr_uprice"		property="pr_uprice"/>
		
		<result column="pd_sq"			property="pd_sq"/>
		<result column="pd_name"		property="pd_name"/>
		<result column="pd_uprice"		property="pd_uprice"/>
		<result column="pd_start_date"	property="pd_start_date"/>
		<result column="pd_end_date"	property="pd_end_date"/>
		<result column="pd_ratio"		property="pd_ratio"/>
		<result column="pd_abc"			property="pd_abc"/>
		<result column="pd_abc_desc"	property="pd_abc_desc"/>

		<result column="tm_id"			property="tm_id"/>
		<result column="tm_name"		property="tm_name"/>
		
		<result column="hr_grade"		property="hr_grade"/>
		<result column="hr_job_skill"	property="hr_job_skill"/>
		
	</resultMap>

	<resultMap type="com.sqisoft.iqs.humanResource.deployRequirements.vo.DeployRequirementsVO" id="DeployRequirementsVO">
		<result column="pj_id"				property="pj_id"/>
		<result column="pj_name"			property="pj_name"/>
		<result column="tm_id"				property="tm_id"/>
		<result column="pj_status"			property="pj_status"/>
		<result column="pj_sign_client"		property="pj_sign_client"/>
		<result column="pj_order_client"	property="pj_order_client"/>
		<result column="pj_LMD"				property="pj_LMD"/>
		<result column="pj_start_date"		property="pj_start_date"/>
		<result column="pj_end_date"		property="pj_end_date"/>
		<result column="pj_intro_stage"		property="pj_intro_stage"/>
		<result column="pj_begin_stage"		property="pj_begin_stage"/>
		<result column="pj_propose_stage"	property="pj_propose_stage"/>
		<result column="pj_contract_stage"	property="pj_contract_stage"/>
		<result column="pj_perform_stage"	property="pj_perform_stage"/>
		<result column="pj_pm"				property="pj_pm"/>
		<result column="pj_loc"				property="pj_loc"/>
		<result column="pj_cwm_env"			property="pj_cwm_env"/>
		<result column="pj_os"				property="pj_os"/>
		<result column="pj_DB"				property="pj_DB"/>
		<result column="pj_ui"				property="pj_ui"/>
		<result column="pj_lang"			property="pj_lang"/>
		<result column="pj_fw"				property="pj_fw"/>
		<result column="pj_mw"				property="pj_mw"/>
		<result column="pj_sqi_mm"			property="pj_sqi_mm"/>
		<result column="pj_out_mm"			property="pj_out_mm"/>
		
		<result column="pj_amount"			property="pj_amount"/>
		<result column="pj_put_num"			property="pj_put_num"/>
		<result column="pj_req_num"			property="pj_req_num"/>
		<result column="pj_matl_cost"		property="pj_matl_cost"/>
		<result column="pj_expense"			property="pj_expense"/>
		<result column="pj_extra_cost"		property="pj_extra_cost"/>
		
		<result column="pr_grade"			property="pr_grade"/>
		<result column="pr_job_skill"		property="pr_job_skill"/>
		<result column="pr_start_date"		property="pr_start_date"/>
		<result column="pr_end_date"		property="pr_end_date"/>
		<result column="pr_name"			property="pr_name"/>
		
		<result column="pr_sq"				property="pr_sq"/>
		<result column="pr_uprice"			property="pr_uprice"/>

		<result column="tm_name"			property="tm_name"/>
		
		<result column="pr_place"			property="pr_place"/>
		
	</resultMap>


	<select id="getTeamNames" resultMap="EmployeeInputVO">
		SELECT	tm_id
				, tm_name
		FROM	team 
		WHERE	tm_year = year(SYSDATE())
	</select>

	<select id="getProjectList" parameterType="string" resultMap="EmployeeInputVO">
		SELECT	pj_id
				, pj_name 
		FROM	project 
		WHERE	tm_id = #{tm_id}
		AND		project.pj_status <![CDATA[<=]]> 4
	</select>
	
	<select id="getProjectInfoByPjId" parameterType="string" resultType="com.sqisoft.iqs.humanResource.employeeInput.vo.EmployeeInputVO">
		SELECT	pj_id
				, pj_name
				, pj_start_date
				, pj_end_date
				, pj_loc
		FROM	project 
		WHERE	pj_id = #{pj_id}
	</select>	
	
	<select id="getHrInfoByName" parameterType="string" resultType="com.sqisoft.iqs.humanResource.humanResource.vo.HumanResourceVO">
		SELECT	hr_name
				, hr_company
				, hr_grade
				, hr_cwm_env
				, hr_uprice
				, hr_job_skill
				, hr_abc
				, hr_residence 
		FROM	human_resource 
		WHERE	hr_name = #{hr_name}
	</select>
	
	<select id="getPjDeployInfoByPjId" parameterType="string" resultMap="EmployeeInputVO">
		SELECT	pj_id
				, pd_sq
				, pr_sq
				, pd_name
				, pd_start_date
				, pd_end_date
				, pd_uprice
				, pd_mm
		FROM	pj_deploy
		WHERE	pj_id = #{pj_id}
		ORDER	BY pd_sq ASC			
	</select>
	
	<select id="getPjRequiredInfoByPjId" parameterType="string" resultMap="DeployRequirementsVO">
		SELECT	pj_id
				, pd_sq
				, pr_sq
				, pr_grade
				, pr_job_skill
				, pr_start_date
				, pr_end_date
				, pr_uprice
				, pr_name 
		FROM	pj_required 
		WHERE	pj_id = #{pj_id}
	</select>
	
	<insert id="insertPjDeploy" parameterType="map">
		INSERT	INTO	pj_deploy	(	pj_id
										, pd_sq
										, pr_sq
										, pd_name
										, pd_start_date
										, pd_end_date
										, pd_uprice
										, pd_ratio
										, pd_mm
									)
				VALUES				(	#{pj_id}
										, #{pd_sq}
										, #{pr_sq}
										, #{pd_name}
										, #{pd_start_date}
										, #{pd_end_date}
										, #{pd_uprice}
										, #{pd_ratio}
										, #{pd_mm}
									)
		ON		DUPLICATE KEY UPDATE 
										pr_sq = #{pr_sq}
										, pd_name = #{pd_name}
										, pd_start_date = #{pd_start_date}
										, pd_end_date = #{pd_end_date}
										, pd_uprice = #{pd_uprice}
										, pd_ratio = #{pd_ratio}
										, pd_mm	= #{pd_mm}
	</insert>
	
	<delete id="deletePjDeploy" parameterType="map">
		DELETE
		FROM	pj_deploy
		WHERE	pj_id = #{pj_id}
		AND		pd_sq = #{pd_sq}
	</delete>
	
	<select id="getEmployeeInputInfo" parameterType="map" resultMap="EmployeeInputVO">
		SELECT	pj_id
				, pd_sq
				, pd_name
				, pr_sq
				, pd_start_date
				, pd_end_date
				, pd_ratio
		FROM	pj_deploy
		WHERE	pj_id = #{pj_id} 
		AND		pd_sq = #{pd_sq}
	</select>
	
	<select id="changePd_sqMax" parameterType="string" resultType="int">
		SELECT	max(pd_sq) + 1
		FROM	pj_deploy
		WHERE	pj_id = #{pj_id}
	</select>
	
	<!-- 20151001 이욱진 추가 -->
	<select id="getDeployL1" parameterType="string" resultMap="EmployeeInputVO">
		SELECT
			pjd.pd_sq
			, pjd.pd_name
			, pjd.pr_sq
			, pjd.pd_start_date
			, pjr.pr_start_date
			, pjd.pd_end_date
			, pjr.pr_end_date
			, pjd.pd_uprice
			, pjr.pr_uprice
			, hr.hr_grade
			, pjr.pr_grade
			, hr.hr_company
			, hr.hr_job_skill
			, pjr.pr_job_skill
			, pjd.pd_ratio
		FROM
			pj_deploy pjd
				LEFT JOIN
					pj_required pjr
				ON
					pjd.pr_sq = pjr.pr_sq
				
				AND
					pjd.pj_id = pjr.pj_id
				LEFT JOIN
					human_resource hr
				ON
					pjd.pd_name = hr.hr_name
		WHERE
			pjd.pj_id = #{pj_id}
	</select>
	
	<select id="getDeployL2" parameterType="string" resultMap="EmployeeInputVO">
		SELECT
			pjr.*
		FROM
			pj_required AS pjr
				LEFT JOIN
					pj_deploy AS pjd
				ON
					pjd.pj_id = pjr.pj_id
				AND
					pjd.pr_sq = pjr.pr_sq
		WHERE
			pjr.pj_id = #{pj_id}
		AND
			pjd.pr_sq IS NULL
	</select>

	<select id="getDeployListByPjId" parameterType="string" resultMap="EmployeeInputVO">
		SELECT	pj_deploy.*
		FROM	pj_deploy
		WHERE	pj_deploy.pj_id = #{pj_id}
	</select>
	
	<update id="updateMM" parameterType="map">
		UPDATE	pj_deploy
		SET		pd_mm = #{pd_mm}
		WHERE	pj_id = #{pj_id}
		AND		pd_sq = #{pd_sq}
	</update>
	
	<select id="getLastSqByPjId" parameterType="string" resultType="_int">
		SELECT	MAX(pd_sq)
		FROM	pj_deploy
		WEHRE	pj_id = #{pj_id}
	</select>
	
	<select id="getProjectNamesByTeamId" parameterType="string" resultType="string">
		SELECT	pj_deploy.pj_id
		FROM	pj_deploy, project
		WHERE	project.pj_id = pj_deploy.pj_id
		AND		project.tm_id = #{tm_id}
		GROUP	BY	pj_deploy.pj_id
	</select>
	
	<select id="getEmployeeInfo" parameterType="map" resultMap="EmployeeInputVO">
		SELECT	p.pj_name
				, pd.pj_id
				, pd.pd_name
				, pd.pd_start_date
				, pd.pd_end_date
		FROM	pj_deploy pd, project p
		WHERE pd.pj_id = p.pj_id
		AND pd.pd_name = #{pd_name}
		ORDER by pd.pd_start_date
	</select>
	
	<select id="getHr_mon_price" parameterType="map" resultType="_int">
		SELECT hp_mon_price
		FROM hr_price hp
		WHERE hp_team = (SELECT tm_id
									FROM project
									WHERE pj_id = #{pj_id})
		AND hp_position = (SELECT hr_position FROM human_resource WHERE hr_name = #{pd_name})
	</select>
	
	<select id="getTm_id" parameterType="string" resultType="string">
		SELECT tm_id
		FROM project
		WHERE pj_id = #{pj_id}
	</select>
	
	<select id="get6M15price" resultType="_int">
		SELECT hp.hp_mon_price
		FROM hr_price hp
		WHERE hp.hp_team = "6M15"
	</select>
	
	<update id="updateCost" parameterType="map">
		UPDATE	project
		SET		pj_emp_mm = #{emp_mm_sum},
				pj_outEmp_mm = #{out_mm_sum},
				pj_direct = #{emp_cost},
				pj_outsrc_cost = #{empOut_cost}
		WHERE	pj_id = #{pj_id}
	</update>
</mapper>
