<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="projectDAO" >
	
	<resultMap type="com.sqisoft.iqs.project.vo.ProjectStageVO" id="pjStageResultMap">
		<result property="pj_stage_id"		column="pj_stage_id"/>
		<result property="pj_stage_name"	column="pj_stage_name"/>
	</resultMap>
	
	<select id="getProjectStageList" resultMap="pjStageResultMap">
		SELECT	*
		FROM	pj_stage
		ORDER	BY pj_stage_id
	</select>
	
	<resultMap type="com.sqisoft.iqs.project.vo.ProjectStatusVO" id="pjStatusResultMap">
		<id		property="pj_status_id"		column="pj_status_id" />
		<result	property="pj_status_name"	column="pj_status_name"/>
		<result	property="pj_status_color"	column="pj_status_color"/>
	</resultMap>
	
	<select id="getProjectStatusList" resultMap="pjStatusResultMap">
		SELECT	*
		FROM	pj_status
		ORDER	BY pj_status_id
	</select>
	<resultMap type="com.sqisoft.iqs.project.vo.ProjectVO" id="projectResultMap">
		<id		property="pj_id"			column="pj_id"/>
		<result	property="pj_name"			column="pj_name"/>
		<result	property="tm_id"			column="tm_id"/>
		<result	property="tm_name"			column="tm_name"/>
		<result	property="pj_status"		column="pj_status"/>
		<result	property="pj_status_name"	column="pj_status_name"/>
		<result	property="pj_sign_client"	column="pj_sign_client"/>
		<result	property="pj_order_client"	column="pj_order_client"/>
		<result	property="pj_amount"		column="pj_amount"/>
		<result	property="pj_LMD"			column="pj_LMD"/>
		<result	property="pj_start_date"	column="pj_start_date"/>
		<result	property="pj_end_date"		column="pj_end_date"/>
		<result	property="pj_stage"			column="pj_stage"/>
		<result	property="pj_propose_date"	column="pj_propose_date"/>
		<result	property="pj_contract_date"	column="pj_contract_date"/>
		<result	property="pj_pm"			column="pj_pm"/>
		<result	property="pj_loc"			column="pj_loc"/>
		<result	property="pj_cwm_env"		column="pj_cwm_env"/>
		<result	property="pj_os"			column="pj_os"/>
		<result	property="pj_DB"			column="pj_DB"/>
		<result	property="pj_ui"			column="pj_ui"/>
		<result	property="pj_lang"			column="pj_lang"/>
		<result	property="pj_fw"			column="pj_fw"/>
		<result	property="pj_mw"			column="pj_mw"/>
		<result	property="pj_req_num"		column="pj_req_num"/>
		<result	property="pj_put_num"		column="pj_put_num"/>
		<result	property="pj_year_sales"	column="pj_year_sales"/>
		<result	property="pj_matl_cost"		column="pj_matl_cost"/>
		<result	property="pj_outsrc_cost"	column="pj_outsrc_cost"/>
		<result	property="pj_extra_cost"	column="pj_extra_cost"/>
		<result	property="pj_sqi_mm"		column="pj_sqi_mm"/>
		<result	property="pj_out_mm"		column="pj_out_mm"/>
		<result	property="pb_no"			column="pb_no"/>
		<result	property="pb_date"			column="pb_date"/>
		<result	property="pj_direct"		column="pj_direct"/>
		<result	property="pj_emp_mm"		column="pj_emp_mm"/>
		<result	property="pj_outEmp_mm"		column="pj_outEmp_mm"/>
		<result property="pj_memo"			column="pj_memo"/>
	</resultMap>
	
	<select id="getProjectListByTeamId" parameterType="string" resultMap="projectResultMap">
		SELECT	*
		FROM	project
		WHERE	tm_id = #{tm_id}
	</select>
	
	<select id="getProjectList" parameterType="map" resultMap="projectResultMap">
		SELECT	*
				, team.tm_id as tm_id
				, project.pj_status as pj_status
				, pj_status.pj_status_name as pj_status_name
		FROM	project, team, pj_status
		WHERE	team.tm_year = #{tm_year}
		AND		team.tm_id = #{tm_id}
		AND		project.tm_id = team.tm_id
		AND		project.tm_id = #{tm_id} 
		AND		project.pj_status = pj_status.pj_status_id
		<if test="pj_status != 0">
		AND		project.pj_status = #{pj_status}
		</if>
		<if test="pj_modify == 1">
		AND		pj_LMD BETWEEN DATE_SUB(NOW(), INTERVAL 7 DAY) AND NOW()
		</if>
		<if test="pj_modify == 2">
		AND		pj_LMD BETWEEN DATE_SUB(NOW(), INTERVAL 14 DAY) AND NOW()
		</if>
		<if test="pj_modify == 3">
		AND		pj_LMD BETWEEN DATE_SUB(NOW(), INTERVAL 1 MONTH) AND NOW()
		</if>
		ORDER	BY project.pj_status
				, pj_id 
	</select>
	
	<!-- 프로젝트 ID만 중복체크...... -->
	<select id="checkDuplicate" parameterType="string" resultType="_int">
		SELECT	COUNT(pj_id)
		FROM	project
		WHERE	pj_id = #{pj_id}
	</select>
	
	<select id="getProjectInfo" parameterType="string" resultType="com.sqisoft.iqs.project.vo.ProjectVO">
		SELECT	p.*, ps.pj_status_name
		FROM	project p, team, pj_status ps
		WHERE	pj_id = #{pj_id}
		AND   p.tm_id = team.tm_id	
        AND  pj_status_name IN (SELECT pj_status_name FROM pj_status WHERE p.pj_status = pj_status.pj_status_id)	
	</select>
	
	<insert id="putNewProjectDetail" parameterType="com.sqisoft.iqs.project.vo.ProjectVO">
		INSERT INTO project	( pj_id
							, pj_name
							, tm_id
							, pj_status
							, pj_sign_client
							, pj_order_client
							, pj_amount
							, pj_LMD
							, pj_start_date
							, pj_end_date
							, pj_stage
							, pj_propose_date
							, pj_contract_date
							, pj_pm
							, pj_loc
							, pj_cwm_env
							, pj_os
							, pj_DB
							, pj_ui
							, pj_lang
							, pj_fw
							, pj_mw
							, pj_req_num
							, pj_put_num
							, pj_year_sales
							, pj_matl_cost
							, pj_extra_cost
							, pj_sqi_mm
							, pj_out_mm
							, pj_memo)
		VALUES				( #{pj_id}
							, #{pj_name}
							, #{tm_id}
							, #{pj_status}
							, #{pj_sign_client}
							, #{pj_order_client}
							, #{pj_amount}
							, SYSDATE()
							, #{pj_start_date}
							, #{pj_end_date}
							, #{pj_stage}
							, #{pj_propose_date}
							, #{pj_contract_date}
							, #{pj_pm}
							, #{pj_loc}
							, #{pj_cwm_env}
							, #{pj_os}
							, #{pj_DB}
							, #{pj_ui}
							, #{pj_lang}
							, #{pj_fw}
							, #{pj_mw}
							, #{pj_req_num}
							, #{pj_put_num}
							, #{pj_year_sales}
							, #{pj_matl_cost}
							<!-- , #{pj_outsrc_cost} -->
							, #{pj_extra_cost}
							, #{pj_sqi_mm}
							, #{pj_out_mm}
							, #{pj_memo})
	</insert>
	
	<update id="modifyProjectProfitAndLossInfo" parameterType="com.sqisoft.iqs.project.vo.ProjectVO">
		UPDATE	project
		SET		pj_LMD = SYSDATE()
				, pj_sqi_mm = #{pj_sqi_mm}
				, pj_out_mm = #{pj_out_mm}
				, pj_matl_cost = #{pj_matl_cost}
				, pj_extra_cost = #{pj_extra_cost}
				<if test= "pj_status == 5">
				, pj_outsrc_cost = #{pj_outsrc_cost}
				</if>
		WHERE	pj_id = #{pj_id}
	</update>
	
	<update id="modifyProjectInfo" parameterType="com.sqisoft.iqs.project.vo.ProjectVO">
		UPDATE	project
		SET		pj_LMD = SYSDATE()
				, pj_amount = #{pj_amount}
				, pj_year_sales = #{pj_year_sales}
				, pj_start_date = #{pj_start_date}
				, pj_end_date = #{pj_end_date}
				, pj_memo = #{pj_memo}
				<if test='pj_name != null and pj_name != "" '>
				, pj_name = #{pj_name}
				</if>
				<if test='pj_status != null and pj_status != "" '>
				, pj_status = #{pj_status}
				</if>
				<if test='pj_sign_client != null and pj_sign_client != "" '>
				, pj_sign_client = #{pj_sign_client}
				</if>
				<if test='pj_order_client != null and pj_order_client != "" '>
				, pj_order_client = #{pj_order_client}
				</if>
				<if test='pj_matl_cost != null and pj_matl_cost != "" '>
				, pj_matl_cost = #{pj_matl_cost}
				</if>
				<if test='pj_extra_cost != null and pj_extra_cost != "" '>
				, pj_extra_cost = #{pj_extra_cost}
				</if>
				<if test='pj_stage != null and pj_stage != "" '>
				, pj_stage = #{pj_stage}
				</if>
				<if test='pj_propose_date != null and pj_propose_date != "" '>
				, pj_propose_date = #{pj_propose_date}
				</if>
				<if test='pj_contract_date != null and pj_contract_date != "" '>
				, pj_contract_date = #{pj_contract_date}
				</if>
		WHERE	pj_id = #{pj_id}
	</update>
	
	<delete id="deleteProjectInfo" parameterType="string">
		DELETE	FROM	project
		WHERE	pj_id = #{pj_id}
	</delete>
	
	<select id= "getProjectNum" parameterType="string" resultType="_int">
		SELECT 	COUNT(*)
		FROM	project
		WHERE	project.tm_id = (	SELECT	tp.tm_id
									FROM	project tp
									WHERE	tp.pj_id = #{pj_id}
								)
		AND		project.pj_id IN (	SELECT	DISTINCT pj_budget.pj_id
									FROM pj_budget
								)
	</select>
</mapper>