<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="deployMapDAO">


	<resultMap type="com.sqisoft.iqs.humanResource.deployMap.vo.DeployMapVO" id="deployResultMap">
		<result property="pd_name"			column="pd_name" />
		<result property="pj_id"			column="pj_id" />
		<result property="pd_start_date"	column="pd_start_date" />
		<result property="pd_end_date"		column="pd_end_date" />
		<result property="tm_id"			column="tm_id" />
		<result property="hr_position"		column="hr_position" />
		<result property="hr_hire_date"		column="hr_hire_date" />
		<result property="hr_quit_date"		column="hr_quit_date" />
		<result property="hr_company"		column="hr_company" />
		<result property="tm_name"			column="tm_name" />
		<result property="startday_r"		column="startday_r" />
		<result property="endday_r"			column="endday_r" />
		<result property="hr_grade"			column="hr_grade"/>
	</resultMap>
	
	<select id="getMonthlyDeployMap" parameterType="String" resultMap="deployResultMap">
		SELECT	d.pd_name			AS	pd_name
				, d.pj_id			AS	pj_id
				, d.pd_start_date	AS	pd_start_date
				, d.pd_end_date		AS	pd_end_date
				, h.tm_id			AS	tm_id
				, h.hr_position		AS	hr_position
				, h.hr_hire_date	AS	hr_hire_date
				, h.hr_quit_date	AS	hr_quit_date
				, h.hr_company		AS	hr_company
				, t.tm_name			AS	tm_name
				, datediff(Last_day(pd_start_date),pd_start_date) startday_r
				, datediff(pd_end_date,DATE_FORMAT(CONCAT(DATE_FORMAT(date_add(pd_end_date, INTERVAL + 0 month) ,'%Y-%m'),'-1'),'%Y-%m-%d'))+1 endday_r
		FROM	pj_deploy d
				, human_resource h
				, team t
		WHERE	d.pd_name = h.hr_name
		AND		h.tm_id = t.tm_id 
		AND		(pd_start_date like concat('%',substring(now(),1,4),'%') OR pd_end_date like concat('%',substring(now(),1,4),'%')) 
		AND		h.hr_company LIKE concat ('%','SQI','%')
		AND		(hr_quit_date like concat('%',substring(now(),1,4),'%') OR hr_quit_date is null OR hr_quit_date ='0000-00-00')
		ORDER	BY h.tm_id
				, d.pd_name
				, d.pd_start_date
	</select>
	
	<!--  팀, 이름 검색 -->
	<select id="getTeamAndNameSearch" parameterType="map" resultMap="deployResultMap">
		SELECT	d.pd_name			AS	pd_name
				, d.pj_id			AS	pj_id
				, d.pd_start_date	AS	pd_start_date
				, d.pd_end_date		AS	pd_end_date
				, h.tm_id			AS	tm_id
				, h.hr_position		AS	hr_position
				, h.hr_hire_date	AS	hr_hire_date
				, h.hr_quit_date	AS	hr_quit_date
				, h.hr_company		AS	hr_company
				, t.tm_name			AS	tm_name
				, datediff(Last_day(pd_start_date),pd_start_date) startday_r
				, datediff(pd_end_date,DATE_FORMAT(CONCAT(DATE_FORMAT(date_add(pd_end_date, INTERVAL + 0 month) ,'%Y-%m'),'-1'),'%Y-%m-%d'))+1 endday_r
		FROM	pj_deploy d
				, human_resource h
				, team t
		WHERE	d.pd_name = h.hr_name
		AND		h.tm_id = t.tm_id
		<if test="radioId == '직원'">
			<if test=" tm_name != null and tm_name !=''">
		AND		t.tm_name = #{tm_name}
		AND		h.hr_company LIKE concat ('%','SQI','%')
			</if>
		</if>
		<if test="radioId == '외주'">
			<if test=" tm_name != null and tm_name !=''">
		AND		t.tm_name = #{tm_name}
		AND		h.hr_company NOT LIKE concat ('%','SQI','%')
			</if>
		</if>
		<if test="hr_name != null and hr_name !=''">
		AND		h.hr_name LIKE concat ('%',#{hr_name},'%')
		</if>
		AND		(pd_start_date like concat('%',substring(now(),1,4),'%') OR pd_end_date like concat('%',substring(now(),1,4),'%')) 
		AND		(hr_quit_date like concat('%',substring(now(),1,4),'%') OR hr_quit_date is null OR hr_quit_date ='0000-00-00')
		ORDER	BY h.tm_id
				, d.pd_name
				, d.pd_start_date
	</select>
	
	
	<select id="getOutDeployMap" parameterType="String" resultMap="deployResultMap">
		SELECT	d.pd_name			AS	pd_name
				, d.pj_id			AS	pj_id
				, d.pd_start_date	AS	pd_start_date
				, d.pd_end_date		AS	pd_end_date
				, h.tm_id			AS	tm_id
				, h.hr_position		AS	hr_position
				, h.hr_hire_date	AS	hr_hire_date
				, h.hr_quit_date	AS	hr_quit_date
				, h.hr_company		AS	hr_company
				, h.hr_grade		AS	hr_grade
				, t.tm_name			AS	tm_name
				, datediff(Last_day(pd_start_date),pd_start_date) startday_r
				, datediff(pd_end_date,DATE_FORMAT(CONCAT(DATE_FORMAT(date_add(pd_end_date, INTERVAL + 0 month) ,'%Y-%m'),'-1'),'%Y-%m-%d'))+1 endday_r
		FROM	pj_deploy d
				, human_resource h
				, team t
		WHERE	d.pd_name = h.hr_name
		AND		h.tm_id = t.tm_id 
		AND		(pd_start_date like concat('%',substring(now(),1,4),'%') OR pd_end_date like concat('%',substring(now(),1,4),'%')) 
		AND		NOT h.hr_company LIKE concat ('%','SQI','%')
		ORDER	BY (
					SELECT	pj_id
					FROM	pj_deploy
					WHERE	pd_name = h.hr_name 
					AND		pd_start_date <![CDATA[<]]> curdate() 
					ORDER	BY pd_end_date desc limit 1
					)
					, d.pd_name
					, d.pd_start_date
	</select>
	
</mapper>
