<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="pjProgressDAO" >
	
	<select id="existWeekProgress" parameterType="map" resultType="_int">
		SELECT	COUNT(*)
		FROM	pj_progress
		WHERE	pj_id = #{pj_id}
		AND		pp_date = #{week}
	</select>
	
	<select id="getPjProgressDonePlan" parameterType="map" resultType="string">
		SELECT	pp_plan
		FROM	pj_progress
		WHERE	pj_id = #{pj_id}
		AND		pp_date = #{lastWeek}
	</select>
	
	<resultMap type="com.sqisoft.iqs.project.vo.PjProgressVO" id="pjProgressResultMap">
		<id		property="pj_id"				column="pj_id"/>
		<id		property="pp_date"				column="pp_date"/>
		<result	property="pp_done"				column="pp_done"/>
		<result	property="pp_plan"				column="pp_plan"/>
		<result	property="pp_issue"				column="pp_issue"/>
		<result	property="pp_priority"			column="pp_priority" />
		<result	property="pp_done_plan"			column="pp_done_plan"/>
		<result	property="pj_name"				column="pj_name"/>
		<result	property="pj_status_color"		column="pj_status_color"/>
		<result	property="pj_status_text_color"	column="pj_status_text_color"/>
	</resultMap>
	
	<select id="getProjectListByPjProgressSearchConditions" parameterType="com.sqisoft.iqs.project.vo.PjProgressSearchVO" resultMap="pjProgressResultMap">
		SELECT	pj_id
				, pj_name
				, pj_status.pj_status_color as pj_status_color
				, pj_status.pj_status_text_color as pj_status_text_color
		FROM	project, team, pj_status
		WHERE	team.tm_year = #{tm_year}
		AND		project.tm_id = team.tm_id
		AND		project.tm_id = #{tm_id} 
		AND		project.pj_status = pj_status.pj_status_id
		<if test="pj_status_id != 0">
		AND		project.pj_status = #{pj_status_id}
		</if>
		ORDER BY pj_status.pj_status_id, pj_id 
	</select>
	
	<select id="getPjProgressByConditions" parameterType="map" resultMap="pjProgressResultMap">
		SELECT	pp_date
				, pj_progress.pj_id as pj_id
				, project.pj_name as pj_name
				, pp_plan
				, pp_done
				, pp_plan
				, pp_issue
				, pp_priority
		FROM	pj_progress, project
		WHERE	pp_date = #{pp_date}
		AND		pj_progress.pj_id = #{pj_id}
		AND		pj_progress.pj_id = project.pj_id
	</select>
	
	<insert id="insertPjProgress" parameterType="com.sqisoft.iqs.project.vo.PjProgressVO">
		INSERT	INTO pj_progress (pj_id, pp_date, pp_done, pp_plan, pp_issue, pp_priority) 
		VALUES	(#{pj_id}, #{pp_date}, #{pp_done}, #{pp_plan}, #{pp_issue}, #{pp_priority})
		ON		DUPLICATE KEY UPDATE pp_done = #{pp_done}, pp_plan = #{pp_plan}, pp_issue = #{pp_issue}, pp_priority = #{pp_priority}
	</insert>
	
	<update id="modifyPjProgress" parameterType="com.sqisoft.iqs.project.vo.PjProgressVO">
		UPDATE	pj_progress
		SET		pp_done = #{pp_done}
				, pp_plan = #{pp_plan}
				, pp_issue = #{pp_issue}
				, pp_priority = #{pp_priority}
		WHERE	pp_date = #{pp_date}
		AND		pj_id = #{pj_id}
	</update>
	
	<delete id="deletePjProgres" parameterType="map">
		DELETE
		FROM	pj_progress
		WHERE	pp_date = #{pp_date}
		AND		pj_id = #{pj_id}
	</delete>
	
	<select id="getPjProgressList" parameterType="map" resultMap="pjProgressResultMap">
		SELECT	pp_date
				, pj_progress.pj_id as pj_id
				, pp_plan
				, pp_done
				, pp_plan
				, pp_issue
				, pp_priority
		FROM	pj_progress
		WHERE	pp_date = #{pp_date}
		AND		pj_progress.pj_id IN (	SELECT	project.pj_id
										FROM	project
										WHERE	project.tm_id = #{tm_id})
		ORDER	BY pp_priority, pj_progress.pj_id								
	</select>
</mapper>