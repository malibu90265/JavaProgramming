<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="EstimateDAO">

<resultMap	type="com.sqisoft.iqs.humanResource.estimate.vo.EstimationVO"	id="estimationListMap">
	<result	property="hr_name"			column="hr_name" />
	<result	property="hr_role"			column="hr_role" />
	<result	property="hr_company"		column="hr_company" />
	<result	property="hr_grade"			column="hr_grade" />
	<result	property="hr_job_skill"		column="hr_job_skill" />
	<result	property="hr_cwm_env"		column="hr_cwm_env" />
	<result	property="pj_id"			column="pj_id" />
	<result	property="pd_name"			column="pd_name" />
	<result	property="pd_abc"			column="pd_abc" />
	<result	property="pd_soft_abc"		column="pd_soft_abc" />
	<result	property="pd_abc_desc"		column="pd_abc_desc" />
	<result	property="pd_start_date"	column="pd_start_date" />
	<result	property="pd_end_date"		column="pd_end_date" />
	<result	property="hr_hire_date"		column="hr_hire_date" />
	<result	property="hr_quit_date"		column="hr_quit_date" />
	<result	property="count"			column="count" />
	<result	property="tm_id"			column="tm_id" />
</resultMap>

	<!-- 기본 리스트 -->
	<select id="getEstViewPage"		resultMap="estimationListMap"	parameterType="string">
		SELECT	h.hr_role
				, h.hr_company
				, hr_grade
				, h.hr_job_skill
				, h.hr_cwm_env
				, d.pj_id
				, d.pd_name
				, d.pd_abc
				, d.pd_soft_abc
				, d.pd_abc_desc
				, d.pd_start_date
				, d.pd_end_date
		FROM	human_resource h
				, pj_deploy d
		WHERE	pj_id =  (	SELECT	pj_id
							FROM	pj_deploy
	                      	WHERE   pd_name = #{hr_name}
							LIMIT 	1
							)
		AND		h.hr_name = d.pd_name
		AND		h.hr_company NOT LIKE concat('%','SQI','%')
    	GROUP	BY  h.hr_name, d.pj_id
		ORDER	BY	d.pj_id
				, d.pd_name;
	</select>
	
	<!-- 년도 셀렉트 박스 옵션 -->
	<select id="getSearchYearOptions"	resultMap="estimationListMap" parameterType="string">
		SELECT	hr_hire_date
				, hr_quit_date
		FROM	human_resource
		WHERE	hr_name = #{hr_name}
	</select>
	<!-- 프로젝트 셀렉트 박스 옵션 -->
	<select id="getSearchPjOptions"	resultType="string" parameterType="string">
		SELECT	pj_id
		FROM	pj_deploy
		WHERE	pd_name = #{hr_name}
		ORDER	BY	pj_id
	</select>
	
	<!-- 검색 프로젝트, 년도-->
	<select		id="getEstViewPageSearch" parameterType="map" resultMap="estimationListMap">
		SELECT	h.hr_role
				, h.hr_company
				, hr_grade
				, h.hr_job_skill
				, h.hr_cwm_env
				, d.pj_id
				, d.pd_name
				, d.pd_abc
				, d.pd_abc_desc
				, d.pd_abc_desc
				, d.pd_start_date
				, d.pd_end_date
		FROM	human_resource h
				, pj_deploy d
		WHERE
		<if test=" pj_id != null and pj_id !=''">
					pj_id = ANY(
								SELECT	pj_id
								FROM	pj_deploy
								WHERE	pd_name = #{hr_name}
								AND		pj_id = #{pj_id})
		</if>
		<if test=" searchYear != null and searchYear !=''">
					pj_id = ANY	(	select	*
									from	(	SELECT	pj_id
												FROM	pj_deploy
												WHERE	pd_name = #{hr_name}
												AND		YEAR(pd_start_date) = #{searchYear}
												LIMIT 1
											) pj_id
								)
		</if>
		AND		h.hr_name = d.pd_name
		AND		h.hr_company NOT LIKE concat('%','SQI','%')
		GROUP	BY  h.hr_name, d.pj_id
		ORDER	BY	d.pj_id, d.pd_name
	</select>
	
	<!-- 업데이트 -->
	<update id="doUpdateSignupdata"		parameterType="map">
		UPDATE	pj_deploy
		SET		pd_abc = #{pd_abc}
				, pd_soft_abc = #{pd_soft_abc}
				, pd_abc_desc = #{pd_abc_desc}
		WHERE	pd_name = #{pd_name}
		AND		pj_id = #{pj_id}
	</update>
	
	<!-- View 기본 리스트 -->
	<select id="getNonTeamEstViewPage"		resultMap="estimationListMap">
		SELECT	h.hr_role
				, h.hr_company
				, hr_grade
				, h.hr_job_skill
				, h.hr_cwm_env
				, d.pj_id
				, d.pd_name
				, d.pd_abc
				, d.pd_soft_abc
				, d.pd_abc_desc
				, d.pd_start_date
				, d.pd_end_date
		FROM	human_resource h
				, pj_deploy d
		WHERE	h.hr_name = d.pd_name
		AND		h.hr_company NOT LIKE concat('%','SQI','%')
		GROUP	BY  h.hr_name, d.pj_id
		ORDER	BY	d.pj_id
				, d.pd_name
	</select>
	
	<!-- View 검색 팀-->
	<select		id="getTeamEstViewPageSearch" resultMap="estimationListMap" parameterType="map">
		SELECT	h.hr_role
				, h.hr_company
				, hr_grade
				, h.hr_job_skill
				, h.hr_cwm_env
				, d.pj_id
				, d.pd_name
				, d.pd_abc
				, d.pd_abc_desc
				, d.pd_abc_desc
				, d.pd_start_date
				, d.pd_end_date
		FROM	human_resource h
				, pj_deploy d
		WHERE	h.hr_name = d.pd_name
		AND		h.hr_company NOT LIKE concat('%','SQI','%')
		<if test=" tm_id != null and tm_id !=''">
		AND		h.tm_id = #{tm_id}
		</if>
		<if test="hr_name != null and hr_name != '' ">
		AND		h.hr_name LIKE concat ('%',#{hr_name},'%')	
		</if>
		GROUP	BY  h.hr_name, d.pj_id
		ORDER	BY	d.pj_id, d.pd_name
	</select>
</mapper>