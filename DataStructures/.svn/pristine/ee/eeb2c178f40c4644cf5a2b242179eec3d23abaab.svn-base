<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="outSalHistoryDao">

	<select id="getHistoryList" parameterType="String" resultType="com.sqisoft.iqs.hr.vo.OutSal_historyVO">
		SELECT	* 
		FROM	outSal_history
		WHERE	name=#{name} 
		ORDER	BY hire_date
	</select>
	
	<delete id="deleteHistory" parameterType="com.sqisoft.iqs.hr.vo.OutSal_historyVO">
		DELETE	
		FROM	outSal_history
		WHERE	name=#{name} 
		AND		hire_date=#{hire_date}
	</delete>
	
	<select id="getHistory" parameterType="String" resultType="com.sqisoft.iqs.hr.vo.OutSal_historyVO">
		SELECT	*
		FROM	outSal_history
		WHERE	name=#{name} 
		AND		hire_date = (
								select	max(hire_date)
								from	outSal_history 
								where	name=#{name}
							)
	</select>
	
	<delete id="deleteHistoryAll" parameterType="com.sqisoft.iqs.hr.vo.OutSal_historyVO">
		DELETE
		FROM	outSal_history
		WHERE	name=#{name}
	</delete>
	
	<delete id="deletePjhistory" parameterType="com.sqisoft.iqs.pf.vo.PjHistoryVO">
		DELETE
		FROM	pj_history
		WHERE	name=#{name} 
		AND		pj_start_day=#{pj_start_day} 
		AND		pj_end_day=#{pj_end_day}
		AND		pj_id=#{pj_id}
	</delete>
	
	<insert id="insertPjhistory" parameterType="com.sqisoft.iqs.pf.vo.PjHistoryVO">
		INSERT	INTO pj_history
		VALUES	(
					#{pj_id}
					,#{name}
					,#{pj_start_day}
					,#{pj_end_day}
					,""
				)
	</insert>
	
	<select id="getOutSalHistory" parameterType="com.sqisoft.iqs.pf.vo.PjHistoryVO" resultType="com.sqisoft.iqs.hr.vo.OutSal_historyVO">
		SELECT	*
		FROM	outSal_history
		WHERE	name = #{name} 
		AND		hire_date <![CDATA[<=]]> #{pj_start_day} 
		ORDER	BY hire_date desc
		LIMIT	1
	</select>
	
	<select id="checkHistory" parameterType="com.sqisoft.iqs.hr.vo.OutSal_historyVO" resultType="com.sqisoft.iqs.pf.vo.PjHistoryVO">
		SELECT	pj_id
				,pj_start_day
				,pj_end_day
				,name
		FROM	pj_history
		WHERE	name=#{name} 
		AND		pj_start_day  <![CDATA[<]]> #{hire_date} 
		AND		pj_end_day <![CDATA[>]]> #{hire_date}
	</select>
	
	<select id="checkOutHis" parameterType="com.sqisoft.iqs.hr.vo.OutSal_historyVO" resultType="Integer">
		SELECT	count(*)
		FROM	outSal_history
		WHERE	name=#{name} 
		AND		hire_date=#{hire_date}
	</select>
	
	<!-- 외주 단가 유효성 검사(매개변수 : 이름) -->
	<select id="checkClear" parameterType="String" resultType="Integer">
		SELECT	count(*)
		FROM	outSal_history h
		WHERE	h.hire_date  <![CDATA[<=]]> (
												SELECT	MIN(pj_start_day) 
												FROM	pj_history 
												WHERE	name=#{name}
											) 
		AND		h.name=#{name}
	</select>
	
	<update id="out_hisUpdate" parameterType="com.sqisoft.iqs.hr.vo.OutSal_historyVO">
		UPDATE	outSal_history
		SET		salary=#{salary}
				, mpm=#{mpm}
		WHERE	name=#{name} 
		AND		hire_date=#{hire_date}
	</update>
	
	<!-- 외주 단가 유효성 부여(매개변수 : 이름) -->
	<update id="adjustSal" parameterType="String">
		UPDATE	outSal_history
		SET		hire_date = (
								select	min(pj_start_day)
								from	pj_history 
								where	name=#{name}
							)
		WHERE	name=#{name} 
		AND		hire_date = (
								select	* 
								from	(
											select	min(hire_date) 
											from	outSal_history 
											where	name=#{name}
										) 
								os 
							)
	</update>
</mapper>