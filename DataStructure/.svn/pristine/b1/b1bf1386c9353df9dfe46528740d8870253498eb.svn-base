<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="UndecidedDAO">
	
	<resultMap type="com.sqisoft.iqs.humanResource.undecided.vo.UndecidedVO" id="UndecidedVO">
		<result column="tm_id"				property="tm_id"></result>
		<result column="tm_name"			property="tm_name"></result>
		<result column="pj_id"				property="pj_id"></result>
		<result column="pj_name"			property="pj_name"></result>
		<!-- undecided custom object -->
		<!-- List.jsp -->
		<result column="require_num"		property="require_num"></result>
		<result column="placements_num"		property="placements_num"></result>
		<result column="deployless_num"		property="deployless_num"></result>
		<result column="deploy_num"			property="deploy_num"></result>
		<!-- ModifyForm.jsp -->
		<result column="pr_sq"				property="pr_sq"></result>
		<result column="pr_grade"			property="pr_grade"></result>
		<result column="pr_job_skill"		property="pr_job_skill"></result>
		<result column="pr_start_date"		property="pr_start_date"></result>
		<result column="pr_end_date"		property="pr_end_date"></result>
		<result column="pr_uprice"			property="pr_uprice"></result>
		<result column="pr_name"			property="pr_name"></result>
		<result column="pd_name"			property="pd_name"></result>
		<result column="hr_residence"		property="hr_residence"></result>
		<result column="isDeploy"			property="isDeploy"></result>
		
	</resultMap>
	
	<select id="getTeamList" resultMap="UndecidedVO">
		SELECT	tm_id
				, tm_name
		FROM	team 
		WHERE	tm_year = year(SYSDATE())
	</select>
	
	<!-- 이건 나중에 수정해야함 너무 날코딩 -->
	<select id="getUndecidedList" parameterType="string" resultMap="UndecidedVO">
	<!-- 수정한 버젼 -->
	SELECT			queue.pj_id AS pj_id
					, queue.pj_name AS pj_name
					, queue.require_num AS require_num
					, queue.placements_num AS placements_num
					, queue.deploy_num AS deploy_num
					, queue.require_num - queue.deployless_num + queue.deploy_num AS deployless_num
	FROM (
			SELECT		p.pj_id
						, p.pj_name
						, IFNULL(first.require_num, 0) AS require_num
						, IFNULL(second.placements_num, 0) AS placements_num
						, ( 			SELECT	count(*)
										FROM	pj_deploy
										WHERE	pj_id = p.pj_id
										AND		pr_sq > require_num
										OR		pj_id = p.pj_id
										AND		pr_sq = 0
						) AS deploy_num
						, IFNULL(third.deployless_num, 0) AS deployless_num
			FROM		project p
			LEFT JOIN	(	SELECT		*
										, count(pr_sq) AS require_num
							FROM		pj_required
							GROUP BY	pj_id
			) AS first
			ON	first.pj_id = p.pj_id
			LEFT JOIN	(	SELECT		*
										, count(*) AS placements_num
							FROM		pj_required
							WHERE		pr_name IS NULL
							OR			TRIM(pr_name) = ""
							GROUP BY	pj_id
			) AS second
			ON	second.pj_id = p.pj_id
			LEFT JOIN	(	SELECT		*
										, count(*) AS deployless_num
							FROM		pj_deploy
							GROUP BY	pj_id
						) AS third
			ON	third.pj_id = p.pj_id
			WHERE	p.tm_id = #{tm_id}
			AND		p.pj_status <![CDATA[<=]]> 4
	) AS queue
	<!-- 예전것 -->
	<!-- 
		SELECT	proj.pj_id AS pj_id
				, proj.pj_name AS pj_name
				, IFNULL(
							(	SELECT	MAX(pr_sq)
								FROM	pj_required subpj1
								WHERE	subpj1.pj_id = proj.pj_id
							), 0
						) AS require_num
				, IFNULL(
							(	SELECT	COUNT(*)
								FROM	pj_required subpj2
								WHERE	subpj2.pj_id = proj.pj_id
								AND		(ISNULL(subpj2.pr_name)
								OR		subpj2.pr_name = '') = TRUE
							), 0
						) AS placements_num
				, (SELECT require_num - (	SELECT
						COUNT(*)
					FROM
						pj_deploy AS subpj3
					WHERE
						subpj3.pj_id = proj.pj_id
					AND
						subpj3.pr_sq
							<![CDATA[<=]]> require_num
				)) AS deployless_num
				, IFNULL(
							(
								SELECT
									COUNT(*)
								FROM
									pj_deploy subpj5
								WHERE
									subpj5.pj_id = proj.pj_id
								AND subpj5.pr_sq > require_num
							), 0
						) AS deploy_num
		FROM	project proj
		WHERE	proj.tm_id = #{tm_id}
		GROUP	BY proj.pj_id -->
	</select>
	
	<select id="getUndecidedModifyList" parameterType="string" resultMap="UndecidedVO">
		SELECT	pjr.pj_id AS pj_id
				, pjr.pr_sq AS pr_sq
				, pjr.pr_grade AS pr_grade
				, pjr.pr_job_skill AS pr_job_skill
				, pjr.pr_start_date AS pr_start_date
				, pjr.pr_end_date AS pr_end_date
				, pjr.pr_uprice AS pr_uprice
				, pjr.pr_name AS pr_name
				, pjd.pd_name AS pd_name
				, res.hr_residence AS hr_residence
				, CONCAT	
					(
						IF	(
								pjd.pj_id = pjr.pj_id
								AND		pjd.pr_sq = pjr.pr_sq
							, '투입'
							,'미투입'
						)
					, '/'
					, IF	(	ISNULL(pjr.pr_name) OR pjr.pr_name = ''
								, '미배치'
								, '배치'
							)
					)
				AS isDeploy
		FROM	pj_required pjr
		LEFT	JOIN
						pj_deploy pjd
		ON		pjr.pj_id = pjd.pj_id
		AND		pjr.pr_sq = pjd.pr_sq
		LEFT	JOIN	(
							SELECT	hr_name
									, hr_residence
							FROM	human_resource
						) res
		ON		pjd.pd_name = res.hr_name
		WHERE	pjr.pj_id = #{pj_id}
	</select>
	
	<insert id="insertUndecided" parameterType="map">
		INSERT	INTO	pj_deploy (
									pj_id
									, pd_sq
									, pd_name
									, pd_uprice
									, pd_start_date
									, pd_end_date
									, pr_sq
								)
				VALUES	(	
							#{pj_id}
							, (
								SELECT	IFNULL(MAX(pjd.pd_sq), 0) + 1
								FROM	pj_deploy pjd
								WHERE	pjd.pj_id = #{pj_id}
								)
							, #{pr_name}
							, #{pr_uprice}
							, #{pr_start_date}
							, #{pr_end_date}
							, #{pr_sq}
						)
	</insert>
	
	<select id="getPjRequiredNum" parameterType="string" resultType="_int">
		SELECT 	count(*) cnt
		FROM  	pj_required
		WHERE  	pj_id = #{pj_id}
	</select>
	
	<select id="getPjDeployNum" parameterType="string" resultType="_int">
		SELECT 	count(*) cnt
		FROM  	pj_deploy
		WHERE  	pj_id = #{pj_id}
	</select>
	
	<select id="getPrNameIsNull" parameterType="string" resultType="_int">
		SELECT 	count(*) cnt
		FROM	pj_required
		WHERE	pr_name = null
		AND 	pj_id = #{pj_id}
	</select>
	
	<select id="getPdNameIsNull" parameterType="string" resultType="_int">
		SELECT 	count(*) cnt
		FROM  	pj_deploy
		WHERE  	pd_name = null
		AND 	pj_id = #{pj_id}
	</select>
</mapper>