<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="manPlaceDao">

	<resultMap type="com.sqisoft.iqs.hr.vo.EmpMapVO" id="empMapResultMap">
		<result property="team_id"		column="team_id" />
		<result property="team_name"	column="team_name" />
		<result property="name"			column="name" />
		<result property="position"		column="position" />
		<result property="project_id"	column="project_id" />
		<result property="division"		column="division" />
		<result property="startday"		column="startday" />
		<result property="endday"		column="endday" />
		<result property="startday_r"	column="startday_r" />
		<result property="startday_r"	column="startday_r" />
		<result property="endday_r"		column="endday_r" />
		<result property="quit_date"	column="quit_date" />
		<result property="hire_date"	column="hire_date" />
		<result property="company"		column="company" />
	</resultMap>

	<!--  미배치 대기 현황 -->
	<select id="getStandByList" resultType="com.sqisoft.iqs.hr.vo.StandByInfoVO">
		SELECT	e.name AS name
				, e.position AS position
				, e.division AS division
				, e.team_id AS team_id
				, pj.pj_id AS project_id
				, t.team_name AS team_name
				, DATE_FORMAT(pj_start_day, '%Y%m%d') AS startday
				, DATE_FORMAT(pj_end_day, '%Y%m%d') AS endday
		FROM	pj_history pj,employee e,team t
		WHERE	e.division='직원' 
		AND		(e.quit_date is null OR e.quit_date='0000-00-00' OR e.quit_date=null) 
		AND		e.name=pj.name  AND e.team_id = t.team_id AND (e.team_id='1S' OR e.team_id='2S' OR e.team_id='3E')
		AND		(pj_start_day like concat('%',substring(now(),1,4),'%') OR pj_end_day  like concat('%',substring(now(),1,4),'%'))  
		ORDER	BY team_id, position, name
		<!--  where e.name="블루베리" OR e.name="장광수" OR e.name="최대환" OR name="최현준" OR name="정미석"
							OR name="박채아" OR name="이현재" OR name="박천수" OR name="홍성수" OR name="조혜영" OR name="송영완"
							OR name="임은정" OR name="조혜영" OR name="백경훈" OR name="오주환" OR name="이정우"  -->
	</select>
	
	
	
	
	<!-- controller까지 존재하나 화면에서 사용 x -->
	
<!-- 	<select id="getTeamProjectList" parameterType="String" resultType="com.sqisoft.iqs.hr.vo.StandByInfoVO">
	
	 	SELECT emp.team_id  	AS team_id,
	 		   UPPER(mpp.cpid)	AS project_id,
	 		   emp.division 	AS division,
	 		   mpp.name     	AS name,
	 		   emp.position 	AS position,
	 		   emp.salary   	AS salary,
	 		   mpp.cpstartday 	AS startday,
	 		   mpp.cpendday 	AS endday
    	FROM mpplace mpp,employee emp
   		WHERE emp.team_id=#{team_id} AND mpp.name=emp.name
	
	</select> -->
	
	
	
	
	<!-- PJ별 투입현황 좌측 리스트  -->
	<select id="getProjectList" parameterType="String" resultType="com.sqisoft.iqs.hr.vo.ProjectVO">
		SELECT	DISTINCT p.pj_id AS pj_id
				, p.pj_start_day AS pj_start_day
				, p.pj_end_day AS pj_end_day
				, cnt AS emp_cnt
		FROM	project p 
		LEFT JOIN 
				(
				SELECT		pj_id
							,count(name) as cnt
				FROM		pj_history 
				WHERE		year(pj_end_day)>=year( SYSDATE()
				) 
		GROUP	BY pj_id
		) as pjcnt ON (p.pj_id=pjcnt.pj_id)
		WHERE	team_id=#{team_id}
		AND		cnt IS NOT NULL 
		AND		p.pj_end_day>=year( SYSDATE())
		
		<!--  mpplace 참조 하던 잘못된 쿼리 
		SELECT DISTINCT p.pj_id AS pj_id,
     	         p.pj_start_day AS pj_start_day,
     	         p.pj_end_day AS pj_end_day,
				 ifnull(cpcnt,0)+ifnull(apcnt,0) AS emp_cnt
		FROM project p LEFT JOIN 
			 (SELECT cpid,count(cpid) as cpcnt
			  FROM mpplace
			  GROUP BY cpid) as pcnt ON (p.pj_id=pcnt.cpid)
    	LEFT JOIN
    		 (SELECT apid,count(apid) as apcnt 
    		  FROM mpplace
    		  GROUP BY apid) as apnt ON (p.pj_id=apnt.apid)
		WHERE ifnull(cpcnt,0)+ifnull(apcnt,0)!=0
 		AND	team_id =#{team_id}
   		ORDER BY p.pj_id,p.pj_end_day
   		-->
		<!-- select DISTINCT pj.pj_id 	   AS 	 pj_id,
     	         pj.pj_start_day       AS    pj_start_day,
     	         pj.pj_end_day       AS    pj_end_day,
                count(mpp.name)        AS 	 emp_cnt  
    	from(select pj_id,
    			 pj_start_day       AS    pj_start_day,
     	         pj_end_day       AS    pj_end_day
        	 from project
         	WHERE team_id =#{team_id})pj,mpplace mpp
    	where mpp.cpid = pj.pj_id  GROUP BY mpp.cpid
   		union all
    	select DISTINCT pj.pj_id 	   AS 	 pj_id,
     	         pj.pj_start_day       AS    pj_start_day,
     	         pj.pj_end_day       AS    pj_end_day,
                count(mpp.name)        AS 	 emp_cnt  
   		from(select pj_id,
     			pj_start_day       AS    pj_start_day,
     	        pj_end_day       AS    pj_end_day
         	from project
        WHERE team_id =#{team_id})pj,mpplace mpp
    	where mpp.apid = pj.pj_id  GROUP BY mpp.apid-->
     <!-- 	    
 		SELECT DISTINCT pj.pj_id 	   AS 	 pj_id,
     	         pj.pj_start_day       AS    pj_start_day,
     	         pj.pj_end_day       AS    pj_end_day,
                count(mpp.name)        AS 	 emp_cnt
          
  			FROM(  SELECT name
   					 FROM employee
    				WHERE team_id =#{team_id}) emp, mpplace mpp,project pj
   
  			WHERE mpp.name = emp.name AND mpp.cpid = pj.pj_id GROUP BY mpp.cpid ORDER BY mpp.cpid ASC,mpp.cpstartday DESC   -->
	<!--    	select DISTINCT pj.pj_id 	   AS 	 pj_id,
	     	         pj.pj_start_day       AS    pj_start_day,
	     	         pj.pj_end_day       AS    pj_end_day,
	                count(mpp.name)        AS 	 emp_cnt  
	    from(select pj_id,
	     pj_start_day       AS    pj_start_day,
	     	         pj_end_day       AS    pj_end_day
	         from project
	         WHERE team_id =#{team_id})pj,mpplace mpp
	    where mpp.cpid = pj.pj_id GROUP BY mpp.cpid ORDER BY mpp.cpid ASC,mpp.cpstartday DESC 
		원래 쿼리 문 -->
	</select>
	
	<!-- PJ별 투입현황 우측 상세정보 -->
 	<select id="getDetailProjectList" parameterType="HashMap" resultType="com.sqisoft.iqs.hr.vo.StandByInfoVO">
 		SELECT	PH.PJ_ID AS project_id
				, PH.NAME AS NAME
				, EMP.position AS position
				, EMP.division AS division
				, EMP.salary AS salary
				, DATE_FORMAT(PH.pj_start_day
				, '%Y%m%d') AS startday
				, DATE_FORMAT(PH.pj_end_day, '%Y%m%d') AS endday  
		FROM	pj_history PH
				, employee EMP
		WHERE	PH.PJ_ID = #{pj_id} 
		AND		PH.NAME = EMP.NAME 
		AND		year( PH.pj_end_day) > year( SYSDATE())-1 
		<!-- AND year( PH.pj_end_day) >= year( SYSDATE())    // 이거추가하면 2015년 전에 끝난 프로젝트 안보여줌 근데 오늘이 기준임 현재 년도가 기준임? -->
		ORDER	BY EMP.NAME
		   
		      <!--   
		   SELECT mpp.cpid	    	AS project_id,
		     	  mpp.name     		AS name,
		     	  emp.position 		AS position,
		     	  emp.division      AS division,
		     	  emp.salary		AS salary,
			 	  DATE_FORMAT(mpp.cpstartday, '%Y%m%d') 	AS startday,
			 	  DATE_FORMAT(mpp.cpendday, '%Y%m%d')  		AS endday  
		   
		   FROM (SELECT pj.team_id,
		   				name,
		   				cpid,
		   				mpp.cpstartday as cpstartday,
		   				mpp.cpendday as cpendday,
		   				mpp.apstartday as apstartday
		   		   FROM mpplace mpp,project pj
		   	      WHERE cpid=#{pj_id} AND pj.pj_id=#{pj_id}) mpp,employee emp
		   
		   WHERE mpp.name=emp.name AND  mpp.team_id = #{team_id} ORDER BY emp.division,mpp.name -->
		 
	</select>
	
	
	<select id="getOutSalList" parameterType="HashMap" resultType="com.sqisoft.iqs.hr.vo.OutSal_historyVO">
		SELECT	out2.name AS name
				, DATE_FORMAT(out2.hire_date, '%Y%m%d') AS hire_date
				, out2.salary AS salary
				, out2.mpm AS mpm
	    FROM	(
				SELECT	name AS name
						, DATE_FORMAT(max(hire_date), '%Y%m%d') AS hire_date
				FROM	outSal_history
				WHERE	name= #{name} 
				AND		hire_date <![CDATA[<=]]> #{startDay} limit 1
				) 
				out1
				, outSal_history out2
		WHERE	out1.name=out2.name AND out1.hire_date=out2.hire_date
		UNION
		SELECT	name AS name
				, DATE_FORMAT(hire_date, '%Y%m%d') AS hire_date
				, salary AS salary
				, mpm AS mpm
		FROM	outSal_history
		WHERE	name= #{name} 
		AND		hire_date <![CDATA[>=]]> #{startDay} 
		AND		hire_date <![CDATA[<=]]> #{endDay} 
		ORDER	BY hire_date DESC
	   
      
    	<!-- ver1 SELECT name,
    	       DATE_FORMAT(hire_date, '%Y%m%d') AS hire_date,
    	       salary,
    	       mpm
    	          
    	FROM outSal_history
    	WHERE name= #{name} AND hire_date  &gt;=  #{startDay} AND hire_date &lt;=   #{endDay} ORDER BY hire_date --> 
    	
    	
   <!-- ver2   SELECT 
		 name 							    AS name,
   		 DATE_FORMAT(max(hire_date), '%Y%m%d')   AS hire_date,
   		 salary 							AS salary,
   	     mpm 							    AS mpm
   	    	
   	    FROM  outSal_history
	   WHERE  name= #{name} AND hire_date  &lt;  #{startDay} limit 1

	UNION

      SELECT 
      	  name 							 	AS name,
    	  DATE_FORMAT(hire_date, '%Y%m%d')  AS hire_date,
    	  salary 							AS salary,
    	  mpm 							    AS mpm
    	          
    	FROM outSal_history
    	WHERE name= #{name} AND hire_date  &gt;=  #{startDay} AND hire_date &lt;= #{endDay} 
      
      ORDER BY hire_date  -->
      
	</select>
	
	<select id="getEmpMapList" parameterType="String" resultMap="empMapResultMap">
		SELECT	t.team_name
				, e.name
				, e.position
				, e.team_id
				, e.quit_date
				, e.hire_date
				, h.pj_id
				, e.division
				, h.pj_start_day
				, h.pj_end_day
				, datediff(Last_day(pj_start_day),pj_start_day) startday_r
				, datediff(pj_end_day,DATE_FORMAT(CONCAT(DATE_FORMAT(date_add(pj_end_day, INTERVAL + 0 month) ,'%Y-%m'),'-1'),'%Y-%m-%d'))+1 endday_r
		FROM	pj_history h
				, team t 
				, employee e
		WHERE	h.name=e.name 
		AND		e.team_id = t.team_id 
		AND		(pj_start_day like concat('%',substring(now(),1,4),'%') OR pj_end_day like concat('%',substring(now(),1,4),'%')) 
		AND		e.division='직원'
		AND		(quit_date like concat('%',substring(now(),1,4),'%') OR quit_date is null OR quit_date ='0000-00-00')
		ORDER	BY t.team_id
				, name 
				, pj_start_day
	<!--   	// 전년도 project를 삭제하지 않을 경우 현소속팀을 pj의 팀으로 나타낼 때
		SELECT t.team_name,
	  		   e.name,
	  		   e.position,
	  		   p.team_id,
	  		   e.quit_date,
	  		   e.hire_date,
	  		   h.pj_id,
	  		   e.division,
	  		   h.pj_start_day,
	  		   h.pj_end_day,
	  		   datediff(Last_day(h.pj_start_day),h.pj_start_day) startday_r,
 			   datediff(h.pj_end_day,DATE_FORMAT(CONCAT(DATE_FORMAT(date_add(h.pj_end_day, INTERVAL + 0 month),'%Y-%m'),'-1'),'%Y-%m-%d'))+1 endday_r
		FROM   pj_history h, team t , employee e, project p
		WHERE  h.name=e.name AND t.team_id=(SELECT team_id FROM pj_history a, project b WHERE a.pj_id=b.pj_id AND a.name=e.name AND a.pj_start_day &lt; curdate() ORDER BY a.pj_end_day desc limit 1 ) AND h.pj_id=p.pj_id
		AND    (h.pj_start_day  like concat('%',substring(now(),1,4),'%') OR h.pj_end_day  like concat('%',substring(now(),1,4),'%')) AND e.division='직원'
		AND    (quit_date like concat('%',substring(now(),1,4),'%') OR quit_date is null OR quit_date ='0000-00-00')
		ORDER BY t.team_id, e.name, h.pj_start_day
	-->
	
	</select>
	
	
	<select id="getOutMapList" parameterType="String" resultMap="empMapResultMap">
		SELECT	t.team_name
				, e.name
				, e.position
				, e.team_id
				, e.company
				, h.pj_id
				, e.division
				, h.pj_start_day
				, h.pj_end_day
				, datediff(Last_day(pj_start_day),pj_start_day) startday_r
				, datediff(pj_end_day,DATE_FORMAT(CONCAT(DATE_FORMAT(date_add(pj_end_day, INTERVAL + 0 month) ,'%Y-%m'),'-1'),'%Y-%m-%d'))+1 endday_r
		 FROM	pj_history h
		 		, team t 
		 		, employee e
		 WHERE	h.name=e.name 
		 AND	e.team_id = t.team_id
		 AND	(pj_start_day  like concat('%',substring(now(),1,4),'%') OR pj_end_day  like concat('%',substring(now(),1,4),'%')) 
		 AND	e.division='외주'
		 ORDER	BY (
		 			SELECT	pj_id
		 			FROM	pj_history
		 			WHERE	name=e.name 
		 			AND		pj_start_day <![CDATA[<]]> curdate() 
		 			ORDER	BY pj_end_day desc limit 1
		 			)
		 			, name, pj_start_day
	</select>
	
	<select id="getPersonalInfo" resultType="com.sqisoft.iqs.hr.vo.Employee_VO">
   		SELECT	emp.*
				, location.e_area
				, t.team_name AS team_name
		FROM	employee emp
				, team t
				, (
					SELECT	concat(a.name," ",b.name) as e_area, concat(b.contcd,"/",b.citycd,"/",b.gucd) as loc
					FROM	area a
							,area b
					WHERE	a.citycd = b.citycd and a.gucd =0 and b.gucd!=0
				  ) as location
		WHERE	emp.team_id=t.team_id 
		AND		location.loc=emp.area 
		AND		emp.name=#{name}
	<!-- 	SELECT emp.* ,t.team_name AS team_name
		FROM employee emp,team t
		WHERE emp.name=#{name} AND emp.team_id=t.team_id  -->
	</select>
	
	
	<select id="getPersonalSkill" resultType="com.sqisoft.iqs.hr.vo.SkillVO">
		SELECT	skil.skill_name AS name
		FROM	(
					SELECT	u.empname as em
							, s.name as skill_name
					FROM	userskill u
							, skillcode s
					WHERE	u.fieldcd=s.fieldcd 
					AND		u.groupcd=s.groupcd 
					AND		u.skillcd=s.skillcd 
					AND		u.fieldcd='1'
				) as skil            
		WHERE	skil.em=#{name} 
	</select>
	
	
	<select id="getJob" resultType="com.sqisoft.iqs.hr.vo.SkillVO">
		SELECT	skl.job AS name
		FROM	employee emp
				,	(
						SELECT	u.empname as nm
								, s.name as job
						FROM	userskill u
								, skillcode s
						WHERE	u.fieldcd=s.fieldcd 
						AND		u.groupcd=s.groupcd 
						AND		u.fieldcd='2'
					) as skl
		WHERE	emp.name=#{name}
		AND		emp.name=skl.nm 
	</select>

</mapper>



